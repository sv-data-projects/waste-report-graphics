<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Kerbside waste callout grapahics">
        <meta name="author" content="Sustainability Victoria">
        <link rel="stylesheet" href="./css/core.css">
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/iframe-resizer/4.3.2/iframeResizer.contentWindow.js" integrity="sha512-cJ7aOLpXbec1Km9craM6xL6UOdlWf9etIz7f+cwQv2tuarLm3PLb3dv3ZqIK++SE4ui+EE0nWqKB0dOaAOv9gQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>  

        <style>
            /***********************************************************/
            /***********************************************************/
            /****                                                   ****/
            /**** KERBSIDE COLLECTION INFOGRAPHIC  | CUSTOM CSS     ****/
            /**** ---------------------------------------------     ****/
            /**** - CSS Variables and loaded fonts from core.css    ****/
            /****                                                   ****/
            /***********************************************************/
            /***********************************************************/

            @font-face {
                font-family: 'Better Times';
                src: local('Better Times'),
                    url('./fonts/Better-Times.ttf') format('truetype');
                font-weight: 400;
                font-style: normal;
            }

            body{
                font-family: 'DIN Next LT Pro';
                margin: 0;                          /* Full bleed presentation */
            }

            /************************/
            /*****  TYPOGRAPHY    ***/
            /************************/

            .recycling-rate-main{
                font-size: 70px;
                letter-spacing: -3px;
                font-weight: 400;
            }
            .main-title,
            .lga-label-headline{
                font-size: 30px;
            }
            .main-title{
                fill:  #000;
                text-transform: uppercase;
            }
            .waste-destination-title,
            .lga-stream-title{
                font-size: 24px;
            }
            .lga-label-title{
                font-size: 36px;
                font-weight: 500;
            }
            .lga-label-small,
            .lga-label,
            .lga-data-label.large, 
            .recycling-breakdown-label, 
            .recycling-rate-label, 
            .table-header,
            .table-content, 
            .lga-annotation{
                font-size: 20px;
            }
            .recycling-breakdown-material-label{
                font-size: 13px;
                text-anchor: end;
            }
            .lga-label,
            .lga-label-headline,
            .waste-destination-title,
            .lga-stream-title,
            .recycling-breakdown-label,
            .recycling-rate-label,
            .bold{
                font-weight: 500;
            }
            .recycling-rate-main{
                font-weight: 600;
            }
            .waste-destination-title,
            .lga-stream-title, 
            .recycling-rate-main,
            .recycling-rate-label, 
            .middle{
                text-anchor: middle;
            }
            .recycling-breakdown-label, 
            .recycling-breakdown-material-label, 
            .recycling-rate-main{
                dominant-baseline: middle;
            }

            .lga-label-small{
                mix-blend-mode: darken;
            }

            /************************************/
            /**** STREET SCENE WASTE GRAPHIC  ***/
            /************************************/

            /* Typography  */
            .shadow.recycling{
                fill: var(--xDarkYellow);
            }
            .garbage, 
            .contaminants{
                fill: var(--tertiaryRed);
            }
            .recycling {
                fill: var(--xDarkYellow);
            }
            .organics {
                fill: var(--tertiaryEmerald);
            }
            .lga-label-title,
            .lga-label-small, 
            .waste-destination-title,
            .lga-stream-title, 
            .lga-data-label.large{
                fill:  #000;
            }
            .waste-destination-title,
            .lga-stream-title{   
                font-weight: 500;
                text-transform: uppercase;
            }

            .lga-data-label.large{
                mix-blend-mode: multiply;
            }
            /* Extended typography options */
            .extended-typography .main-title,
            .extended-typography .waste-destination-title,
            .extended-typography .lga-stream-title{
                font-family: 'Better Times';
                font-size: 30px;
            }
            .extended-typography .waste-destination-title.garbage{
                font-size: 40px;
                letter-spacing: 2px;
            }
            .extended-typography .main-title{
                font-size: 50px;
                transform: translateY(25px);
            }

            /* Inset circular graphics including material colour assignment */
            .recycling-breakdown-chart-bg, 
            .recycling-breakdown-outer{
                stroke: var(--xCharcoal);
            }
            .recycling-breakdown-chart-bg{
                fill:           #fff;
                fill-opacity:   0.7;
                stroke-width:   2px;
            }
            .recycling-breakdown-outer{
                stroke-width: 0.5px;
            } 
            .paper,
            .paper-and-cardboard{
                fill: var(--xBlueCyan );
            }
            .recycling-breakdown-material-label.paper,
            .recycling-breakdown-material-label.paper-and-cardboard{
                fill: var(--xDarkBlueCyan);
            }
            .plastics{
                fill: var(--tertiaryYellow);
            }
            .recycling-breakdown-material-label.plastics{
                fill: var(--xDarkYellow);
            }
            .metals{
                fill: var(--xMidBlue);
            }
            .recycling-breakdown-material-label.metals{
                fill: var(--tertiaryBlue);
            }
            .glass{
                fill: var(--tertiaryPurpleLight)
            }
            .recycling-breakdown-material-label.glass{
                fill: var(--tertiaryPurple);
            }
            .contaminants{
                fill: var(--tertiaryRed);
            }
            .recycling-breakdown-material-label.contaminants{
                fill: var(--tertiaryRed);
            }

            /* Flow paths */
            .flowPath{
                stroke-linejoin: round;
                fill: none;
                stroke-dasharray: 1.5 5;
            }
            .flowPath.recycling.paper,
            .flowPath.recycling.paper-and-cardboard{
                stroke-dasharray: 1.5 20;
                stroke-dashoffset: 0;
                stroke: var(--secondaryBottleGreenLight);
            }
            .flowPath.recycling.plastic{
                stroke-dasharray: 1.5 20;
                stroke-dashoffset: 5;
                stroke: var(--tertiaryBlue);
            }
            .flowPath.recycling.glass{
                stroke-dasharray: 1.5 20;
                stroke-dashoffset: 10;
                stroke: var(--tertiaryPurpleLight)
            }
            .flowPath.recycling.metal{
                stroke-dasharray: 1.5 20;
                stroke-dashoffset: 15;
                stroke: var(--tertiaryBlueLight);
            }
            .flowPath.garbage{
                stroke: var(--tertiaryRed);
            }
            .flowPath.organics{
                stroke: var(--tertiaryEmerald);
            }
        </style>
    </head>

    <body>
        <div class = "svg-container">
            <svg id = "kerbside-graphic" class ='extended-typography'>
                <title id="svg-title"></title>
                <desc id="svg-description"></desc>
                <!-- 2. CENTRE ILLUSTRATION FOR THE MRF AND LANDFILL SCENE -->
                <g id = "destination-scene" transform="translate(720, 100) scale(1)">
                    <defs>
                        <clipPath id="a" clipPathUnits="userSpaceOnUse">
                            <path fill="#ff0" d="M120.873 138.9a.128.128 0 00-.128.129v3.888l-13.881.05a.108.108 0 00-.109.107v20.91c0 .06.049.107.109.107 20.582-.111 63.248.059 63.248.059s.128-18.903.128-25.071a.128.128 0 00-.128-.128z"/>
                        </clipPath>
                        <clipPath id="b" clipPathUnits="userSpaceOnUse">
                            <path fill="#5d7a5a" d="M169.207 124.721c-.996.006-1.846.51-2.022 1.928H136.98c-2.216 0-4.053 1.784-4 4 .069 2.386-.046 8.585-.06 9.357l-4.032.054s-1.176-5.292-3.37-6.134c-1.05-.402-3.522-.726-4.583-.018-2.016 1.346-1.619 5.32-1.706 10.245v10.655c0 2.216 1.784 4 4 4h11.394c.692 1.024 1.653 2.245 2.357 2.53h34.165c4.432 0 8-3.569 8-8v-18.689a7.98 7.98 0 00-7.9-7.997c-.174-1.423-1.03-1.93-2.03-1.93h-.008z"/>
                        </clipPath>
                    </defs>
                    <path class = "sky" fill="var(--secondaryGreyLightest)" d="M-388.285 204C298.443-82.731 945.97-65.578 1595.258 204v375.633H-388.285z"/>
                    <path class = "ground" fill="#c8ab37" d="M458.211 513.585h416.948v60.923H458.211z"/>
                    <path class = "foreground-grass" fill="#D5E0A1" d="M-388.776 579.613c277.38-170.866 617.885-172.25 854.673-154.826-.601 27.529 14.06 149.008 14.06 149.008z"/>
                    <path class = "foreground-grass" fill="#D5E0A1" d="M1591.542 598.231c-257.8-114.563-325.884-189.535-877.28-173.444.6 27.529-16.28 129.386-14.06 149.008 299.705 4.497 591.637 19.829 891.34 24.436z"/>
                    <path fill="#668000" d="M147.66 433.268c45.087 20.51 45.773 66.02 171.067 12.547 111.378-33.595-2.914-29.678-171.067-12.547z"/>
                    <g>
                        <path class = "road" fill="#7991A9" d="M159.247 444.127c-216.63 55.61-321.793 120.665-113.632 127.82l655.655-8.99c145.413 1.444 341.293-1.026 516.892 9.83 133.563-10.114-81-106.958-166.028-129.528l55.3-2.07c152.067 21.515 373.91 142.08 118.475 139.453l-1245.321 4.154c-3.003-.622-369.142 6.358-369.142 6.358l.26-5.525s227.095-12.048 331.27-3.861c-211.381-32.989-115.417-54.64 159.778-139.375z"/>
                        <g transform="translate(-700 120)">
                            <path fill="#c87137" d="M471.767 421.988v-27.206h-16.443c-7.039 21.966-15.572 15.44-20.817-7.75l-7.446.353c3.031 19.6 12.442 43.253 30.253 25.296v8.41z"/>
                            <circle cx="438.742" cy="345.075" r="26.75" fill="teal"/>
                            <circle cx="460.954" cy="380.097" r="22.116" fill="#71c837"/>
                            <circle cx="482.838" cy="381.467" r="22.116" fill="#aade87"/>
                            <circle cx="428.599" cy="381.342" r="22.116" fill="#aade87"/>
                        </g>
                        <path fill="#a80" d="M61.91 441.181l.796-89.864 59.143-35.965 67.135 36.365-3.326 94.145z"/>
                        <path fill="#241c1c" d="M63.255 353.559c32.295 32.215 60.403 34.249 124.29 28.613V350.43l-68.404-34.873L60.572 347.3" opacity=".3"/>
                        <path fill="#aca793" d="M62.915 441.383l-.25-87.468-4.795-1.2.1 90.414z"/>
                        <path fill="#d3bc5f" d="M192.98 342.925l-1.748 86.717 107.647-3.197.4-77.126z"/>
                        <path fill="#c8ab37" d="M191.382 344.923v13.187l108.695 4.396v-12.388z"/>
                        <path fill="#fc0" d="M122.533 305.48l69.925 39.398 106.82 6.04s-52.35-30.371-54.347-30.371c-1.999 0-122.398-15.068-122.398-15.068z"/>
                        <path fill="#aca793" d="M192.938 444.47l.632-98.889-5.784-1.057-.277 100.664z"/>
                        <path fill="#e9ddaf" d="M178.325 445.398l9.191.166.67-90.65-9.991-4.396z"/>
                        <path fill="#e9ddaf" d="M192.581 344.923l.4 13.587-72.33-36.764-63.54 35.565-11.193 1.201v-13.587l70.055-38.014c2.474-.809 4.403-2.435 8.274-1.15z"/>
                        <path fill="#e9ddaf" d="M49.168 442.53l8.743.499v-86.317l-8.792-3.996z"/>
                        <path fill="#e9ddaf" d="M125.845 321.245l-8.53.325-50.847 30.032 7.589-3.842c-.239 1.195-2.747 15.885-2.747 15.885l-7.047-5.614.116-5.195-1.794 1.059c.073 7.75.119 15.498.119 23.248l58.346-26.825 57.347 24.427v-9.19l.233-7.635-6.991 5.612-2.172-16.131 9.595 3.972s-35.68-20.203-53.217-30.128zm2.676 4.288l11.632 5.894-11.787 9.305s-.31-.62.155-15.2zm-14.695.014c.597-.12.12 15.287.12 15.287l-10.987-9.196s10.27-5.971 10.867-6.09zm32.842 9.292l14.424 7.134-11.788 9.15zm-49.92.382l-2.269 16.72-10.988-9.077zm44.957 1.634l1.55 12.253-9.926-5.74zm-39.464 1.113l8.48 7.643-10.27 5.613s1.67-12.42 1.79-13.256zm61.487 8.038l2.172 14.424-12.252-6.359zm-83.7 1.396l10.63 9.076-13.138 7.405zm-15.765 16.84l5.494 4.18-5.374 2.746z"/>
                        <path fill="#217844" d="M212.463 358.113l-.4 22.275c-.097 4.559 2.675 3.38 4.795 3.506l68.333-.593-.681-21.924z"/>
                        <path fill="#a80" d="M193.346 405.528l-.305 38.876 110.9-14.584-3.143-26.51z"/>
                        <path fill="#a80" d="M331.056 368.86l30.482 3.46 1.207 51.91-32.217 6.251z"/>
                        <path fill="#ffe680" d="M326.591 344.37c2.409-.363 4.47-.168 4.824 2.756l-.345 19.294c-.3 1.856-1.485 2.612-3.123 3.101l-71.986 9.647c-2.666-.145-5.338-.282-5.168-4.479V362.63c.278-3.482 2.129-6.57 7.57-6.88z"/>
                        <path fill="#d4aa00" d="M330.044 344.298c1.668 0 37.105 3.655 37.105 3.655 2.992 1.028 2.025 2.847 2.502 4.377l-.417 17.609c-.891 2.362-.222 4.097-3.335 3.335-.834-.209-36.272-3.752-36.272-3.752z"/>
                        <path fill="#fc0" d="M331.056 368.86l-.141 61.97-72.592 2.274.905-55.19z"/>
                        <path fill="#784421" d="M300.574 432.783c.302-1.207 1.811-34.65-.905-34.951-2.716-.302-18.41 1.047-18.41 1.047l-.603 34.064"/>
                        <circle cx="119.498" cy="408.19" r="6.743" fill="#374845"/>
                        <circle cx="126.803" cy="407.415" r="6.743" fill="#ff2a7f"/>
                        <circle cx="136.874" cy="405.644" r="6.743" fill="#a40"/>
                        <circle cx="142.076" cy="408.743" r="6.743" fill="#540"/>
                        <path fill="#217867" d="M128.693 409.548c3.665-.38 20.98-1.39 20.98-1.39 2.507 1.927.923 3.445.253 5.055l-21.739 2.022z"/>
                        <path fill="#93aca7" d="M128.263 414.939l-21.111-1.489-.767 20.654 21.333 2.625z"/>
                        <path fill="#216778" d="M128.263 415.21l21.294-1.906-.75 19.63-20.943 3.58z"/>
                        <path fill="#5fd3bc" d="M128.535 409.49l-22.156.046c-3.107.708-2.396 3.38.102 4.128l21.92 1.673c1.952-.39 2.707-5.533.134-5.846z"/>
                        <path fill="#216778" d="M108.384 415.008l-.411 18.965.924-.184.238-8.54c2.609.236 5.936.83 7.084.336l-7.062-1.273.39-8.173c3.321.278 6.612.542 7.907-.126z"/>
                        <path fill="#216778" d="M117.33 416l-.41 18.965.717.075.232-8.624c2.89.234 6.56.893 8.229.46l-8.201-1.48.233-8.68c3.137.15 10.426 1.247 8.27.289z"/>
                        <g>
                            <circle cx="83.728" cy="414.819" r="6.743" fill="#374845"/>
                            <circle cx="91.033" cy="414.044" r="6.743" fill="#ff2a7f"/>
                            <circle cx="101.105" cy="412.273" r="6.743" fill="#a40"/>
                            <circle cx="106.306" cy="415.372" r="6.743" fill="#540"/>
                            <path fill="#217867" d="M92.923 416.176c3.665-.379 20.98-1.39 20.98-1.39 2.507 1.927.923 3.446.253 5.055l-21.738 2.023z"/>
                            <path fill="#93aca7" d="M92.493 421.567l-21.11-1.488-.768 20.653 21.334 2.626z"/>
                            <path fill="#216778" d="M92.493 421.84l21.294-1.907-.75 19.63-20.942 3.58z"/>
                            <path fill="#5fd3bc" d="M92.766 416.12l-22.157.045c-3.107.708-2.396 3.38.102 4.127l21.92 1.674c1.953-.39 2.708-5.533.135-5.847z"/>
                            <path fill="#216778" d="M72.614 421.637l-.41 18.965.924-.184.238-8.54c2.608.236 5.936.83 7.084.336l-7.062-1.273.389-8.174c3.321.279 6.613.542 7.907-.125z"/>
                            <path fill="#216778" d="M81.561 422.629l-.41 18.964.716.076.232-8.624c2.891.234 6.56.893 8.229.46l-8.201-1.48.234-8.68c3.137.149 10.426 1.247 8.27.288z"/>
                        </g>
                        <!-- <g transform="translate(0 -5)">
                            <path fill="#c87137" d="M143.03 550.664v-25.092h-15.166c-6.491 20.26-14.362 14.241-19.199-7.148l-6.867.326c2.796 18.076 11.475 39.892 27.901 23.33v7.757z"/>
                            <circle cx="126.486" cy="507.925" r="21.776" fill="#aade87"/>
                            <circle cx="107.598" cy="478.008" r="24.671" fill="#87de87"/>
                            <circle cx="151.715" cy="518.817" r="18.881" fill="#b3ff80"/>
                            <circle cx="89.254" cy="504.058" r="27.291" fill="#cfa"/>
                        </g> -->
                        <g id="landfill">
                            <circle cx="529.941" cy="539.384" r="13.485"fill="#483e37"/>
                            <circle r="13.485" cy="519.182" cx="548.554"fill="#6c5d53"/>
                            <circle cx="561.986" cy="536.598" r="13.485"fill="#6c5d53"/>
                            <circle r="13.485" cy="536.598" cx="561.986" fill="#6c5d53"/>
                            <circle cx="625.38" cy="526.845" r="13.485"fill="#2b2200"/>
                            <circle r="13.485" cy="514.037" cx="558.621" fill="#2b2200"/>
                            <circle r="13.485" cy="517.838" cx="525.28" fill="#483e37"/>
                            <circle cx="570.346" cy="512.912" r="13.485"fill="#6c5d53"/>
                            <circle r="13.485" cy="527.541" cx="598.908" fill="#ac9d93"/>
                            <circle cx="598.908" cy="527.541" r="13.485"fill="#ac9d93"/>
                            <path d="M599.159 557.229l-48.808-36.514 56.026-24.011z" fill="#ac9d93"/>
                            <path d="M615.116 515.37l-48.807-36.514 56.026-24.01z" fill="#ac9d93"/>
                            <path transform="rotate(-50.126 1059.754 570.744) scale(.42876)" d="M1800.859 474.236l-72.387-54.155 83.093-35.612z" fill="#a05a2c"/>
                            <circle r="13.485" cy="499.006" cx="591.535"  fill="#483e37"/>
                            <circle cx="578.667" cy="496.597" r="6.641"   fill="#6c5d53"/>
                            <circle r="13.485" cy="505.116" cx="608.524"  fill="#6c5d53"/>
                            <circle cx="514.897" cy="512.235" r="13.485"  fill="#6c5d53"/>
                            <circle r="13.485" cy="511.788" cx="669.18"   fill="#2b2200"/>
                            <circle cx="610.582" cy="480.065" r="13.485"  fill="#2b2200"/>
                            <circle cx="542.491" cy="504.15" r="6.641"    fill="#483e37"/>
                            <circle r="10.748" cy="490.329" cx="568.591"  fill="#6c5d53"/>
                            <circle cx="632.305" cy="500.304" r="13.485"  fill="#ac9d93"/>
                            <circle r="13.485" cy="476.212" cx="634.933"  fill="#ac9d93"/>
                            <path transform="rotate(-33.321 1172.357 707.543) scale(.42876)"  d="M1800.859 474.236l-72.387-54.155 83.093-35.612z" fill="#a05a2c""/>
                            <circle r="13.485" cy="475.898" cx="559.233"  fill="#483e37"/>
                            <circle cx="590.986" cy="524.657" r="13.485"  fill="#6c5d53"/>
                            <circle r="13.485" cy="542.073" cx="604.418"  fill="#6c5d53"/>
                            <circle cx="631.137" cy="549.519" r="13.485"  fill="#6c5d53"/>
                            <circle r="13.485" cy="532.32" cx="667.811"   fill="#2b2200"/>
                            <circle cx="686.056" cy="550.529" r="13.485"  fill="#2b2200"/>
                            <circle cx="560.969" cy="523.313" r="13.485"  fill="#483e37"/>
                            <circle r="13.485" cy="490.792" cx="654.827"  fill="#6c5d53"/>
                            <circle cx="641.339" cy="533.016" r="13.485"  fill="#ac9d93"/>
                            <circle r="13.485" cy="533.016" cx="641.339"  fill="#ac9d93"/>
                            <path transform="rotate(20.052 664.996 634.498)"  d="M641.59 562.704l-48.807-36.514 56.026-24.011z" fill="#ac9d93""/>
                            <path d="M699.144 519.77l-48.807-36.514 56.026-24.01z" fill="#ac9d93" />
                            <path transform="rotate(-50.126 1095.73 480.842) scale(.42876)" d="M1800.859 474.236l-72.387-54.155 83.093-35.612z" fill="#a05a2c"/>
                            <circle cx="534.098" cy="498.787" r="13.485"  fill="#483e37"/>
                            <circle r="13.485" cy="513.812" cx="485.276"  fill="#6c5d53"/>
                            <circle cx="515.607" cy="485.186" r="13.485"  fill="#6c5d53"/>
                            <circle r="13.485" cy="546.182" cx="548.13"   fill="#6c5d53"/>
                            <circle cx="696.377" cy="497.316" r="13.485"  fill="#2b2200"/>
                            <circle r="13.485" cy="502.185" cx="497.953"  fill="#2b2200"/>
                            <circle r="9.721" cy="478.184" cx="589.316"   fill="#483e37"/>
                            <circle cx="684.008" cy="473.382" r="13.485"  fill="#6c5d53"/>
                            <circle r="13.485" cy="528.556" cx="506.098"  fill="#ac9d93"/>
                            <circle cx="688.589" cy="528.446" r="13.485"  fill="#ac9d93"/>
                            <path transform="matrix(.4895 -.20554 .2428 .47982 -471.52 706.254)" d="M1800.859 474.236l-72.387-54.155 83.093-35.612z" fill="#a05a2c"/>
                        </g>
                        <path fill="#668000" d="M927.224 471.785c-17.071 2.545-81.842 8.2-124.94-10.43 32.428-6.013 192.504-6.781 124.94 10.43z"/>
                        <g transform="translate(-22)">
                            <path fill="#803300" d="M1145.052 441.63l.4-90.313-59.143-35.965-67.136 36.365 3.326 94.145z"/>
                            <path fill="#d4aa00" d="M1144.287 439.774c-45.36-5.006-40.904-55.399-72.56-105.356l17.29-18.862 58.568 31.743" opacity=".3"/>
                            <path fill="#cdde87" d="M1145.093 443.029c-.4-1.599.4-89.114.4-89.114l4.795-1.2-.4 90.713z"/>
                            <path fill="#efa" d="M1015.177 342.925l-.014 100.859-105.884-17.34-.4-77.125z"/>
                            <path fill="#afe" d="M995.695 358.113l.4 22.275c.097 4.559-2.675 3.38-4.795 3.506l-68.333-.593.68-21.924z"/>
                            <path fill="#cdde87" d="M1016.776 344.923v13.187l-108.248.811-.448-8.803z"/>
                            <path fill="#aade87" d="M1085.625 305.48l-69.925 39.398-107.399 5.399 54.926-29.73z"/>
                            <path fill="#dde9af" d="M1015.24 444.932l.337-99.21 4.795-1.198 1.769 100.722z"/>
                            <path fill="#abc837" d="M1029.832 445.398l-7.881.648-1.979-91.132 9.99-4.396z"/>
                            <path fill="#abc837" d="M1015.577 344.923l-.4 13.587 72.33-36.764 63.54 35.565 9.102 1.111-.382-12.059-67.582-39.452c-2.474-.809-4.404-2.435-8.274-1.15z"/>
                            <path fill="#abc837" d="M1156.764 443.428l-6.517-.4v-88.226l6.118 1.352z"/>
                            <path fill="#abc837" d="M1082.313 321.245l8.53.325 50.847 30.032-7.59-3.842c.24 1.195 2.748 15.885 2.748 15.885l7.047-5.614-.116-5.195 1.793 1.059c-.073 7.75-.118 15.498-.118 23.248l-58.347-26.825-57.347 24.427v-9.19l-.233-7.635 6.992 5.612 2.171-16.131-9.347 4.467-.02-.63zm-2.676 4.288l-11.633 5.894 11.788 9.305s.31-.62-.155-15.2zm14.695.014c-.597-.12-.12 15.287-.12 15.287l10.987-9.196s-10.27-5.971-10.867-6.09zm-32.842 9.292l-14.424 7.134 11.787 9.15zm49.92.382l2.268 16.72 10.989-9.077zm-44.957 1.634l-1.551 12.253 9.927-5.74zm39.464 1.113l-8.48 7.643 10.27 5.613s-1.671-12.42-1.79-13.256zm-61.488 8.038l-2.171 14.424 12.252-6.359zm83.701 1.396l-10.63 9.076 13.137 7.405zm15.765 16.84l-5.495 4.18 5.375 2.746z"/>
                            <path fill="#dde9af" d="M1014.812 405.528l.305 38.876-107.13-17.37 1.027-22.523z"/>
                            <circle cx="-1090.66" cy="410.19" r="6.743" fill="#d45500" transform="scale(-1 1)"/>
                            <circle cx="-1083.355" cy="409.415" r="6.743" fill="#8a0" transform="scale(-1 1)"/>
                            <circle cx="-1073.283" cy="407.644" r="6.743" fill="#a40" transform="scale(-1 1)"/>
                            <circle cx="-1068.082" cy="410.743" r="6.743" fill="#540" transform="scale(-1 1)"/>
                            <path fill="#217867" d="M1081.465 411.548c-3.665-.38-20.98-1.39-20.98-1.39-2.507 1.927-.923 3.445-.253 5.055l21.739 2.022z"/>
                            <path fill="#93aca7" d="M1081.895 416.939l21.11-1.489.768 20.654-21.333 2.625z"/>
                            <path fill="#216778" d="M1081.895 417.21l-21.294-1.906.75 19.63 20.943 3.58z"/>
                            <path fill="#5fd3bc" d="M1081.622 411.49l22.157.046c3.107.708 2.396 3.38-.102 4.128l-21.92 1.673c-1.952-.39-2.708-5.533-.135-5.846z"/>
                            <path fill="#216778" d="M1101.774 417.008l.41 18.965-.924-.184-.238-8.54c-2.608.236-5.936.83-7.083.336l7.061-1.273-.389-8.173c-3.321.278-6.613.542-7.907-.126z"/>
                            <path fill="#216778" d="M1092.827 418l.411 18.965-.717.075-.232-8.624c-2.89.234-6.56.893-8.229.46l8.201-1.48-.233-8.68c-3.138.15-10.427 1.247-8.271.289z"/>
                            <circle cx="-1126.429" cy="412.819" r="6.743" fill="#668000" transform="scale(-1 1)"/>
                            <circle cx="-1113.198" cy="409.484" r="6.743" fill="#450" transform="scale(-1 1)"/>
                            <circle cx="-1103.851" cy="413.372" r="6.743" fill="#540" transform="scale(-1 1)"/>
                            <path fill="#217867" d="M1117.235 414.176c-3.666-.379-20.98-1.39-20.98-1.39-2.508 1.927-.924 3.446-.254 5.055l21.74 2.023z"/>
                            <path fill="#93aca7" d="M1117.664 419.567l21.111-1.488.767 20.653-21.333 2.626z"/>
                            <path fill="#216778" d="M1117.664 419.84l-21.294-1.907.75 19.63 20.943 3.58z"/>
                            <path fill="#5fd3bc" d="M1117.392 414.12l22.156.045c3.107.708 2.397 3.38-.101 4.127l-21.92 1.674c-1.953-.39-2.708-5.533-.135-5.847z"/>
                            <path fill="#216778" d="M1137.544 419.637l.41 18.965-.924-.184-.238-8.54c-2.609.236-5.936.83-7.084.336l7.062-1.273-.389-8.174c-3.322.279-6.613.542-7.908-.125z"/>
                            <path fill="#216778" d="M1128.597 420.629l.41 18.964-.717.076-.232-8.624c-2.89.234-6.56.893-8.228.46l8.2-1.48-.233-8.68c-3.137.149-10.426 1.247-8.27.288z"/>
                        </g>
                        <path fill="#d38d5f" d="M936.368 442.966l-59.282 1.598 27.883-41.202z"/>
                        <path fill="#ff7f2a" d="M817.738 454.967l-57.652 1.683 27.116-43.375z"/>
                        <path fill="#c87137" d="M924.96 463.25l-66.887 1.957 31.46-50.437z"/>
                        <g>
                            <g transform="matrix(-1.74086 0 0 1.74086 1051.866 279.318)">
                                <rect width="49.371" height="11.66" x="122.886" y="156.812" fill="#8ca18e" ry="2.729" transform="skewX(-.79) scale(1 .9999)"/>
                                <rect width="9.679" height="7.372" x="96.752" y="162.691" fill="#4c6463" rx="0"/>
                                <rect width="6.584" height="9.51" x="94.782" y="161.087" fill="#eaf3e0" ry="2.6"/>
                                <path fill="#a4c283" d="M117.099 139.056c-3.214.22-6.522.047-9.766.034-4.367-.07-7.879 4.213-7.97 7.225v15.093c0 .804.648 1.452 1.452 1.452h16.284c1.43 0 2.58-1.151 2.58-2.58v-18.644c0-1.43-1.15-2.58-2.58-2.58zm-11.19 3.33h7.355c.554 0 1 .446 1 1v7.944c0 .554-.446 1-1 1h-9.471c-.554 0-1.263-1.664-1.113-2.197l1.93-6.822c.15-.533.745-.925 1.3-.925z"/>
                                <path fill="#1a1a1a" d="M106.259 159.136h14.296v9.183h-14.296z"/>
                                <path fill="#758b7b" d="M120.699 168.079c-.667-5.632-2.542-8.408-6.891-8.87-6.248.178-7.558 4.52-7.623 9.481-.042.97-2.146 1.116-2.107.112-.15-5.216-.788-12.362 10.26-12.294 5.34.068 8.465 4.555 8.532 11.563-.039 1.198-2.135 2.023-2.656.116z"/>
                                <path fill="#424e42" d="M100.849 149.816a2.156 4.717 0 01-2.157 4.717 2.156 4.717 0 01-2.156-4.717 2.156 4.717 0 012.156-4.717 2.156 4.717 0 012.157 4.717"/>
                                <path fill="#dbecea" d="M100.694 149.768a1.51 4.34 0 01-1.51 4.34 1.51 4.34 0 01-1.509-4.34 1.51 4.34 0 011.51-4.34 1.51 4.34 0 011.51 4.34"/>
                                <path fill="#89d684" d="M169.207 124.721c-.996.006-1.846.51-2.022 1.928H136.98c-2.216 0-4.053 1.784-4 4 .069 2.386-.046 8.585-.06 9.357l-4.032.054s-1.176-5.292-3.37-6.134c-1.05-.402-3.522-.726-4.583-.018-2.016 1.346-1.619 5.32-1.706 10.245v10.655c0 2.216 1.784 4 4 4h11.394c.692 1.024 1.653 2.245 2.357 2.53h34.165c4.432 0 8-3.569 8-8v-18.689a7.98 7.98 0 00-7.9-7.997c-.174-1.423-1.03-1.93-2.03-1.93h-.008z"/>
                                <path fill="#4c6b44" d="M157.036 124.721c-.996.006-1.846.51-2.022 1.928H124.81c-2.216 0-4.052 1.785-4 4 .069 2.386-.045 8.585-.06 9.357l-4.032.054s-1.176-5.292-3.37-6.134c-1.05-.402-3.522-.726-4.583-.018-2.016 1.346-1.619 5.32-1.706 10.245v10.655c0 2.216 1.784 4 4 4h11.394c.692 1.024 1.653 2.245 2.357 2.53h34.165c4.432 0 8-3.569 8-8v-18.689a7.98 7.98 0 00-7.899-7.997c-.175-1.423-1.03-1.93-2.03-1.93h-.01z" clip-path="url(#a)" transform="translate(12.17)"/>
                                <path fill="#999" d="M132.416 149.66c-.386.949.289 2.448.289 2.448h-5.918c-1.82 0-3.287 1.206-3.287 2.704 0 1.499 1.466 2.705 3.287 2.705l7.125-.053.71 1.343h45.66v-9.122z" clip-path="url(#b)" opacity=".4"/>
                                <rect width="10.537" height="3.257" x="152.505" y="128.557" fill="#c2dfab" ry="1.629"/>
                            </g>
                            <g transform="matrix(-1.74086 0 0 1.74086 1051.866 279.318)">
                                <circle cx="159.962" cy="168.457" r="5.227" fill="#313e39"/>
                                <circle cx="159.962" cy="168.457" r="4.181" fill="#425046"/>
                                <circle cx="159.962" cy="168.457" r="1.447" fill="#748577"/>
                            </g>
                            <g transform="matrix(-1.74086 0 0 1.74086 1051.866 279.318)">
                                <circle cx="145.916" cy="168.537" r="5.227" fill="#313e39"/>
                                <circle cx="145.916" cy="168.537" r="4.181" fill="#425046"/>
                                <circle cx="145.916" cy="168.537" r="1.447" fill="#748577"/>
                            </g>
                            <g transform="matrix(-1.74086 0 0 1.74086 1051.866 279.318)">
                                <circle cx="113.463" cy="168.449" r="5.227" fill="#313e39"/>
                                <circle cx="113.463" cy="168.449" r="4.181" fill="#425046"/>
                                <circle cx="113.463" cy="168.449" r="1.447" fill="#748577"/>
                            </g>
                        </g>
                        <!-- <g transform="translate(-9 130)">
                            <path fill="#c87137" d="M412.39 418.919v-33.395h-20.184c-8.64 26.962-19.114 18.953-25.552-9.514l-9.14.435c3.721 24.057 15.273 53.09 37.134 31.049v10.324z"/>
                            <circle cx="390.371" cy="362.038" r="28.981" fill="#aade87"/>
                            <circle cx="365.233" cy="322.221" r="32.834" fill="#87de87"/>
                            <circle cx="423.949" cy="376.533" r="25.128" fill="#b3ff80"/>
                            <circle cx="340.82" cy="356.891" r="36.321" fill="#cfa"/>
                        </g> -->
                        <g transform="matrix(-1 0 0 1 586.862 -20)">
                            <path fill="#5992c7" d="M315.94 491.242l-6.397.405c-9.182-.33-10.964 8.232-10.93 12.89v83.938c0 .23.855.417 1.917.417s1.918-.186 1.918-.417v-83.937c.441-7.209 4.554-8.93 7.176-8.923l6.073-.162z" opacity=".8"/>
                            <rect width="10.609" height="3.158" x="316.507" y="494.562" fill="#39506a" rx="26.075" ry=".417"/>
                            <path fill="#f0ecc9" d="M315.697 495.615h12.552c-.287-2.704 1.575-6.106-6.883-6.155-2.963.117-5.051.995-5.75 2.268z"/>
                            <path fill="#e6e7c1" d="M307.922 494.65c-5.62-.087-7.395 7.018-7.361 11.677v82.716c0 .231-.365.417.697.417 1.062 0 1.919-.186 1.917-.417l-.61-82.716c.442-7.21 2.967-9.788 5.346-10.754 2.225-.328 1.74-.747.01-.923z"/>
                            <path fill="#e3dbdb" d="M315.697 495.615h5.426c1.77.29 1.02-5.811.243-6.155-2.963.117-5.051.995-5.75 2.268z"/>
                        </g>
                        <g>
                            <path fill="#f4e3d7" d="M880.015 463.487l.646-51.408c-4.558-20.372-64.18-21.674-77.451 0v52.463z"/>
                            <path fill="#916f6f" d="M894.17 370.937l-25.619.376c-17.573 2.303-11.652 18.655-12.367 26.338 1.942 10.451 12.629 8.859 14.576 5.267v-15.426c.002-3.886 2.149-5.946 7.509-5.268h15.901z"/>
                            <path fill="#ffe6d5" d="M860.362 382.218v15.453c-1.153 1.734-2.145 1.544-3.024 0l.698-15.453c.672-1.149 1.383-1.862 2.326 0z"/>
                            <path fill="#c8b7b7" d="M843.1 396.357c2.87 24.373-.925 46.994-9.332 67.8l47.163.125-.27-55.382c-6.04-6.79-26.857-14.647-37.562-12.543z"/>
                            <path fill="none" stroke="#6c5353" stroke-width=".407" d="M803.323 426.47h75.625"/>
                            <path fill="none" stroke="#6c5353" stroke-width=".407" d="M804.816 437.278l73.385-.848"/>
                            <path fill="none" stroke="#6c5353" stroke-width=".407" d="M804.816 446.814h71.644"/>
                        </g>
                        <g transform="translate(33.527 5.588)">
                            <path fill="#c87137" d="M1008.422 532.982v-27.206h-16.444c-7.039 21.966-15.572 15.44-20.817-7.751l-7.446.353c3.031 19.6 12.443 43.254 30.253 25.296v8.411z"/>
                            <circle cx="975.396" cy="456.069" r="26.75" fill="teal"/>
                            <circle cx="997.609" cy="491.091" r="22.116" fill="#71c837"/>
                            <circle cx="1019.492" cy="492.46" r="22.116" fill="#aade87"/>
                            <circle cx="965.254" cy="492.336" r="22.116" fill="#aade87"/>
                        </g>
                        <g transform="translate(376.501 181.45)">
                            <path fill="#c87137" d="M866.97 417.914v-33.395h-20.183c-8.64 26.963-19.114 18.953-25.551-9.513l-9.14.434c3.72 24.057 15.273 53.09 37.134 31.05v10.323z"/>
                            <circle cx="844.953" cy="361.033" r="28.981" fill="#aade87"/>
                            <circle cx="819.815" cy="321.217" r="32.834" fill="#87de87"/>
                            <circle cx="878.53" cy="375.529" r="25.128" fill="#b3ff80"/>
                            <circle cx="795.401" cy="355.886" r="36.321" fill="#cfa"/>
                        </g>
                        <g transform="matrix(-1 0 0 1 1224.522 -25.368)">
                            <path fill="#5992c7" d="M315.94 491.242l-6.397.405c-9.182-.33-10.964 8.232-10.93 12.89v83.938c0 .23.855.417 1.917.417s1.918-.186 1.918-.417v-83.937c.441-7.209 4.554-8.93 7.176-8.923l6.073-.162z" opacity=".8"/>
                            <rect width="10.609" height="3.158" x="316.507" y="494.562" fill="#39506a" rx="26.075" ry=".417"/>
                            <path fill="#f0ecc9" d="M315.697 495.615h12.552c-.287-2.704 1.575-6.106-6.883-6.155-2.963.117-5.051.995-5.75 2.268z"/>
                            <path fill="#e6e7c1" d="M307.922 494.65c-5.62-.087-7.395 7.018-7.361 11.677v82.716c0 .231-.365.417.697.417 1.062 0 1.919-.186 1.917-.417l-.61-82.716c.442-7.21 2.967-9.788 5.346-10.754 2.225-.328 1.74-.747.01-.923z"/>
                            <path fill="#e3dbdb" d="M315.697 495.615h5.426c1.77.29 1.02-5.811.243-6.155-2.963.117-5.051.995-5.75 2.268z"/>
                        </g>
                    </g>
                </g>
            </svg>
        </div>
        
    </body>

    <script>

        /////////////////////////////////////////////////////////////////////////////////
        /// 0. BUILD SEQUENCE: INIT SETTINGS AND DATA OBJECTS AND LOADING => RENDER  ///
        ////////////////////////////////////////////////////////////////////////////////

        const settings = {
            svgID:          'kerbside-graphic',
            year:           '2019-20', 
            dims: {
                height:     350, 
                width:      1080,
                margin: {
                    top: 100, right: 50, bottom: 50, left: 100
                }
            }
        }

        const data = {          // Initiate data object that populated by the parseData() function, 
            table:        {},
            byPeriod:       {},
            byType:   {
                material: {}
            },
            schema: {
                list:  {}
            }
        }


        // Build from GSheet data
        buildFromGSheetData(settings)

        function buildFromGSheetData(settings) {
            d3.select(`#${settings.svgID}`).style('opacity', 0)
            // 1. Specify data table links for each table used (tsv published output from each separate sheet/table)
            const gsTableLinks =   {
                kerbsideCollectionData:         'https://docs.google.com/spreadsheets/d/e/2PACX-1vSimVJWCqYLTijgqeU-SPGdAFT6wpGprHgjPdpxEElWurVvl28JYr7dHGE3OCSjF4VYH2_QggJUnveO/pub?gid=204435756&single=true&output=tsv',
                kerbsideComposition:            'https://docs.google.com/spreadsheets/d/e/2PACX-1vSimVJWCqYLTijgqeU-SPGdAFT6wpGprHgjPdpxEElWurVvl28JYr7dHGE3OCSjF4VYH2_QggJUnveO/pub?gid=1848611910&single=true&output=tsv',
                kerbsideCollectionData5yr:      'https://docs.google.com/spreadsheets/d/e/2PACX-1vSimVJWCqYLTijgqeU-SPGdAFT6wpGprHgjPdpxEElWurVvl28JYr7dHGE3OCSjF4VYH2_QggJUnveO/pub?gid=558277010&single=true&output=tsv',
            }

            // 2. Asynchronous data load (with Promise.all) and D3 (Fetch API) 
            Promise.all(
                Object.values(gsTableLinks).map(link => d3.tsv(link))       // Pass in array of d3.tsv loaders with each link
            ).then( rawData => {
                // a. Parse each loaded data table and store in data.table object, using the parseTable helper 
                rawData.forEach((tableData, i) => {  parseTable(Object.keys(gsTableLinks)[i], tableData) })
                return data

            }).then( async (data) => {
                // 3. Initiate vis build sequence with data now loaded
                await applyQuerySettings(settings)                                                                 // a. Update settings if a query string is passed in
                await transformData(data.table.kerbsideCollectionData   , data.table.kerbsideComposition)          // b. Parse data
                await renderVis(data.table.kerbsideCollectionData, data.table.kerbsideComposition, settings)       // c. Render visualisation(s)
                await animateVis(settings)       // d. Animate in
            })

            // X. Table data parsing function: trim() header white space and prase numbers with "$" and "," stripped. 
            const parseTable = (tableName, tableData) => {
                data.table[tableName] = tableData.map(row => {
                    const newObj = {}
                    Object.entries(row).forEach(([key, value]) => {
                        switch(key.trim().toLowerCase()){
                            case 'year':
                                newObj[key.trim()] =  value
                                break     
                            default:
                                newObj[key.trim()] = isNaN(parseFloat(value.replace(/\$|,/g, ''))) ? value : parseFloat(value.replace(/\$|,/g, '')) 
                        }
                    })
                    return newObj
                })
            };                
        };


        ////////////////////////////////////
        // 1. PARSE AND WRANGLE DATA     ///
        ////////////////////////////////////

        async function applyQuerySettings(settings){
            // i. Check for query parameters and update material. A date set by the query selector is set while parsing input data 
            settings.queryParameters = new URLSearchParams(window.location.search)
            if (settings.queryParameters.has('year')) { 
                settings.year = settings.queryParameters.get('year')  
            }
            if (settings.queryParameters.has('extended-typography')) { 
                d3.select(`#${settings.svgID}`).classed('extended-typography', settings.queryParameters.get('extended-typography') === "false" ? false  : true)
             }
        };

        async function transformData(kerbsideData, recycleBinData) {      
            // 1. Extract lists
            data.schema.list.year =   [...new Set(kerbsideData.map( d => d.year))]
            data.schema.list.kerbsideRecycleMaterials =   [...new Set(recycleBinData.map( d => d.material))]
            data.schema.list.kerbsideRecycleMaterialGroups =   [...new Set(recycleBinData.map( d => d.group))]
        };


        ///////////////////////////////////////////////////////////////////////////////////
        // 2. RENDER THE CALLOUT  GRAPHIC                                               ///
        // This render is a cut down version of the full kerbside graphic illustration  ///
        ///////////////////////////////////////////////////////////////////////////////////

        async function renderVis(collectionData, compositionData, settings){
            // 0. Data
            const yearData = collectionData.filter(d => d.year === settings.year)[0],
                recycleBinData =  compositionData.filter(d => d.year === settings.year),
                totalCouncilCost = d3.sum(Object.keys(yearData).filter(d => d.slice(d.indexOf('_') + 1) === 'cost').map( d => yearData[d])),
                totalCollection = d3.sum(Object.keys(yearData).filter(d => d.slice(d.indexOf('_') + 1) === 'volume').map( d => yearData[d]))

            const icons = {
                bin:        "M16.444-2.62a.889.864 0 01-.888.864.889.864 0 01-.89-.864.889.864 0 01.89-.865.889.864 0 01.888.865M15.4-6.07l.582-12.974H1.796l.8 17.776c.028.693.615 1.24 1.328 1.24h9.29A3.386 3.386 0 0112.2-3.77c.482-1.33 1.75-2.242 3.199-2.3zm4.156-15.567h-1.334v.865h1.334a.438.438 0 00.444-.432.438.438 0 00-.444-.433zM15.809-5.2h-.005a2.348 2.348 0 00-.248-.013c-1.456-.008-2.652 1.116-2.694 2.531-.042 1.415 1.085 2.604 2.539 2.678 1.453.075 2.702-.993 2.813-2.404.111-1.412-.957-2.651-2.405-2.792zm-.253 4.308c-.982 0-1.778-.773-1.778-1.728s.796-1.729 1.778-1.729c.981 0 1.777.774 1.777 1.729 0 .458-.187.898-.52 1.222a1.803 1.803 0 01-1.257.506zm1.333-19.015a.439.439 0 00.444-.432v-.432H.444A.438.438 0 000-20.34c0 .239.199.432.444.432zm.444-2.16c0-.24-.199-.433-.444-.433H2.667c-.565 0-1.069.347-1.258.864h15.924z",
                binBody:    "M15.4-6.069l.582-12.974H1.796l.8 17.776c.028.693.615 1.24 1.328 1.24h9.29A3.386 3.386 0 0112.2-3.77c.482-1.33 1.75-2.242 3.199-2.3z",
                binWheel:   "M16.444-2.62a.877.877 0 01-.888.864.877.877 0 01-.89-.864c0-.478.399-.865.89-.865.49 0 .888.387.888.865M15.81-5.2h-.005a2.348 2.348 0 00-.248-.013c-1.456-.008-2.652 1.116-2.694 2.531-.042 1.415 1.085 2.604 2.539 2.678 1.453.075 2.702-.993 2.813-2.404.111-1.412-.957-2.651-2.405-2.792zm-.253 4.308c-.982 0-1.778-.773-1.778-1.728s.796-1.729 1.778-1.729c.981 0 1.777.774 1.777 1.729 0 .458-.187.898-.52 1.222a1.803 1.803 0 01-1.257.506z",
                binLid:     "M19.556-21.636h-1.334v.865h1.334a.438.438 0 00.444-.432.438.438 0 00-.444-.433zm-2.667 1.729a.439.439 0 00.444-.432v-.432H.444A.438.438 0 000-20.34c0 .239.199.432.444.432zm.444-2.16c0-.24-.199-.433-.444-.433H2.667c-.565 0-1.069.347-1.258.864h15.924z",
            }

            // 1. Setup SVG Canvas and layers
            const xTransform = 370, yTransform = 300,
                svg = d3.select(`#${settings.svgID}`).attr('viewBox', `${xTransform} ${yTransform} ${settings.dims.width} ${settings.dims.height} `),
                defs = d3.select('defs'),
                annotationLayer = svg.append('g').classed('annotation-group', true).attr('transform', `translate(${xTransform}, ${yTransform})`),
                infographicLayer = annotationLayer.append('g') 

            const recyclingInsert = {x: settings.dims.width * 0.8, y: settings.dims.height * 0.65},
                diversionInsert = {x: settings.dims.width * 0.2, y: settings.dims.height * 0.65}

                // a. Iconograph settings 
                const iconWidth = 20,  iconHeight = 22.5, iconBinHeight = 19.3, iconScale = 1.15, binColour = '#252d2f'

                // b. Add the flow paths
                const  recycleContaminationRate = recycleBinData.filter(d => d.group ==='Contaminants')[0].volume / d3.sum(Object.values(recycleBinData).map(d => d.volume)),
                    collectionDataYear = data.table.kerbsideCollectionData5yr.filter(d => d.year === settings.year)[0],
                    organicsContaminationRate = 1 - (collectionDataYear['Organics_Tonnes recovered'] / collectionDataYear['Organics_Tonnes collected'])

            // 2. Setup title and desc for screen reader accessibility
            const svgTitleText = `Waste diversion rate and bin waste composition in ${settings.year})`,
                svgDescText = `An illustrated scene with callout graphics for waste diversion rate and bin waste composition in ${settings.year}, for ${recycleBinData.map(d => d.material).toString()}) `

            d3.select('#svg-title').html(svgTitleText)
            d3.select('#svg-description').html(svgDescText)

            // Toggle title so that it doesn't appear as a default tooltip
            svg.on('mouseover', () => document.getElementById('svg-title').innerHTML = null )
                .on('mouseout', () =>  document.getElementById('svg-title').innerHTML = svgTitleText )

            // 3. Recycling breakdown "Bin breakdown graphic"
            const recycleBinScale = 6, 
                chartBgRadius = 120,
                recyclingBreakdownChart = annotationLayer.append('g').classed('icon-chart destination', true).attr('id', 'recycling-breakdown-icon-chart')
                    .attr('transform', `translate(${recyclingInsert.x}, ${recyclingInsert.y})`)

                let cumulativeProp = -iconBinHeight
                // a. Chart background circle
                recyclingBreakdownChart.append('circle')
                    .classed('recycling-breakdown-chart-bg', true)
                    .attr('r', chartBgRadius)
                    .attr('transform', `translate(${chartBgRadius*0.25}, ${-chartBgRadius *0.5})`)

                // b. Breakdown chart label
                const breakdownLabelOffset = 10,
                    breakdownLabelPath = `M${0} ${0}  A${chartBgRadius + breakdownLabelOffset}, ${chartBgRadius + breakdownLabelOffset}, 0, 0, 1, ${0}, ${(chartBgRadius+ breakdownLabelOffset) * 2}
                            A${chartBgRadius+ breakdownLabelOffset}, ${chartBgRadius+ breakdownLabelOffset}, 0, 0, 1, ${0}, ${0}`
                defs.append('path').attr('id', 'breakdown-chart-label-path')
                    .attr('d',breakdownLabelPath )
                recyclingBreakdownChart.append('text').classed('recycling-breakdown-label', true)
                    .attr('transform', `translate(${(chartBgRadius + breakdownLabelOffset) *0.25}, ${-(chartBgRadius) * 1.5 - breakdownLabelOffset })`)
                        .append('textPath').attr("href", `#breakdown-chart-label-path`)
                        .attr("startOffset", '100%')
                        .style("text-anchor", 'end')
                        .text(`What's in our mixed recyclables?`)	
                recyclingBreakdownChart.append('path').classed('recycling-breakdown-outer', true)
                    .attr('d', icons.binBody)
                    .attr('transform', `scale(${recycleBinScale})`)

                // c. Render Breakdown chart 
                    // i. Create chart data
                    const recycleBinChartData = []
                    data.schema.list.kerbsideRecycleMaterialGroups.forEach (group => {
                        recycleBinChartData.push({ group,  volume: d3.sum(recycleBinData.filter(d => d.group === group).map(d => d.volume)) })
                    })
                    // ii. Add each material group
                    recycleBinChartData.forEach((d, i) => {
                        const material = d.group,
                            materialSlug = helpers.slugify(d.group),
                            materialProp = d.volume / d3.sum(recycleBinData.map(d => d.volume)),
                            clipHeight =  materialProp * iconBinHeight
                        
                        // Add part of an icon with a clip path                
                        defs.append('clipPath').attr('id', `recycle-bin-${materialSlug}`)
                            .append('rect')
                            .attr('x', 0)                            
                            .attr('y', cumulativeProp)
                            .attr('height', clipHeight)
                            .attr('width', iconWidth)
                        recyclingBreakdownChart.append('path')
                            .classed(`recycling-breakdown ${materialSlug}`, true)
                            .attr('d', icons.binBody)
                            .attr('clip-path', `url(#recycle-bin-${materialSlug})`)
                            .attr('transform', `translate(${0} , ${0}) scale(${recycleBinScale})`)
                        // Add label    
                        recyclingBreakdownChart.append('text')
                            .classed(`recycling-breakdown-material-label ${materialSlug}`, true) 
                            .attr('transform', material !== 'Contaminants' ?  `translate(${0} , ${(cumulativeProp + clipHeight /2) * recycleBinScale})`  :  `translate(${70} , ${iconHeight * iconScale - 10 })` )
                            .text(`${material}: ${helpers.numberFormatters.formatPct1dec(materialProp)}`) 
                            .style('font-weight', material !== 'Contaminants' ? null : 500 )

                        cumulativeProp += clipHeight     // Update cumulative position for label
                    })

                    // iii. Add bin wheel and lid
                    recyclingBreakdownChart.append('path')
                        .attr('d', icons.binWheel)
                        .attr('transform', `translate(${0} , ${0})  scale(${recycleBinScale})`)
                    recyclingBreakdownChart.append('path')
                        .attr('d', icons.binLid)
                        .attr('transform', `translate(${0} , ${0})  scale(${recycleBinScale})`)

            // 4. Diversion rate circular callout
            const diversionCallout =  annotationLayer.append('g').classed('destination', true)
                .attr('transform', `translate(${diversionInsert.x}, ${diversionInsert.y})`)

                // a. Diversion callout background circle
                diversionCallout.append('circle')
                    .classed('recycling-breakdown-chart-bg', true)
                    .attr('r', chartBgRadius)
                    .attr('transform', `translate(${-chartBgRadius*0.25}, ${-chartBgRadius *0.5})`)

                // b. Circular label
                const diversionLabelPath = `M${0} ${0}  A${chartBgRadius + breakdownLabelOffset}, ${chartBgRadius + breakdownLabelOffset}, 0, 0, 1, ${0}, ${(chartBgRadius+ breakdownLabelOffset) * 2}
                    A${chartBgRadius+ breakdownLabelOffset}, ${chartBgRadius+ breakdownLabelOffset}, 0, 0, 1, ${0}, ${0}`
                defs.append('path').attr('id', 'diversion-callout-label-path')
                    .attr('d',diversionLabelPath )

                diversionCallout.append('text').classed('recycling-breakdown-label', true)
                    .attr('transform', `translate(${-(chartBgRadius + breakdownLabelOffset) *0.25}, ${-(chartBgRadius) * 1.5 - breakdownLabelOffset })`)
                        .append('textPath').attr("href", `#diversion-callout-label-path`)
                        .text(`How much kerbside waste was recovered?`)	

                // c. Headline diversion rate label
                diversionCallout.append('text').classed('recycling-rate-label', true)
                    .attr('transform', `translate(${-chartBgRadius*0.25}, 0)`)
                    .attr('x', 0).attr('y', -106).attr('dy', 0)
                    .text(`Diversion rate of`)	
                diversionCallout.append('text').classed('recycling-rate-main', true)
                    .text(`${helpers.numberFormatters.formatPct1dec(1 - ((yearData.Garbage_volume + yearData.Recycling_volume * recycleContaminationRate + yearData.Organics_volume * organicsContaminationRate) / totalCollection))}`)	
                    .attr('x', 0).attr('y', 0).attr('dy', 0)
                    .attr('transform', `translate(${-chartBgRadius*0.25}, ${-chartBgRadius *0.5})`)
                diversionCallout.append('text').classed('recycling-rate-label', true)
                    .attr('transform', `translate(${-chartBgRadius*0.25}, 0)`)
                    .attr('x', 0).attr('y', -16).attr('dy', 0)
                    .text(`after contamination`)	

        };


        //////////////////////////////////////////////
        // 3. ANIMATION | FADE IN ONLY (FOR NOW)   ///
        //////////////////////////////////////////////

        async function animateVis(settings){
            d3.select(`#${settings.svgID}`).transition().duration(1000)
                .style('opacity', null)
        };

        ////////////////////////////////////
        /// X. HELPER FUNCTIONS |        ///
        ////////////////////////////////////

        const helpers= {
            numberFormatters: {
                formatComma:           	d3.format(",.0f"),
                formatComma1dec:       	d3.format(",.1f"),
                formatComma2dec:       	d3.format(",.2f"),
                formatInteger:         	d3.format(".0f"),   
                formatCostInteger:     	d3.format("$,.0f"),  
                formatCost1dec:        	d3.format("$,.1f"),  
                formatPct:          	d3.format(".0%"), 
                formatPct1dec:          d3.format(".1%")  
            },
            numberParsers: {
                parseDateSlash: d3.timeParse("%d/%m/%Y")
            },
            slugify: function (str) {
                str = str.replace(/^\s+|\s+$/g, '').toLowerCase(); // trim           
                const from = "àáäâèéëêìíïîòóöôùúüûñç·/_,:;",      // remove accents, swap ñ for n, etc
                    to   = "aaaaeeeeiiiioooouuuunc------"
                for (var i=0, l=from.length ; i<l ; i++) {
                    str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
                }
                str = str.replace(/[^a-z0-9 -]/g, '') // remove invalid chars
                    .replace(/\s+/g, '-') // collapse whitespace and replace by -
                    .replace(/-+/g, '-'); // collapse dashes
                return str;
            }, 
            wrap: function(text, width, lineHeight, centerVertical = false) {
                text.each(function() {
                    let text = d3.select(this),
                        words = text.text().split(/\s+/).reverse(),
                        word,
                        line = [],
                        lineNumber = 0,
                        y = text.attr("y"),
                        x = text.attr("x"),
                        fontSize = parseFloat(text.style("font-size")),
                        dy = parseFloat(text.attr("dy")),
                        tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em");

                    while (word = words.pop()) {
                        line.push(word);
                        tspan.text(line.join(" "));

                        if (tspan.node().getComputedTextLength() > width) {
                            line.pop();
                            tspan.text(line.join(" "));
                            line = [word];
                            tspan = text.append("tspan")
                                .attr("x", x)
                                .attr("y",  y)
                                .attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                        }                    
                    }            
                    if(centerVertical){
                        text.style("transform",  "translateY(-"+(10 * (lineNumber))+"px)")
                    }
                })
            },
          }

    </script>
</html>

